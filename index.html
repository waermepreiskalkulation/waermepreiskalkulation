<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=600, initial-scale=1, user-scalable=0">
  <meta name="description" content="Berechnung des Wärmepreises für den Blumengarten">
  <meta name="author" content="Sven Beisiegel">
  <title>Wärmepreiskalkulation</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://www.google.com/s2/favicons?domain=techem.com&sz=128"/>
  <!-- Scripts -->
  <script type="text/javascript" src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <!-- Scripts -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>
  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://unpkg.com/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"/>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto:400,900');
    .container{ width: 100%; display: block; padding: 0px; justify-content: space-evenly !important; }
    .product-name { font-family: 'Roboto', sans-serif; font-size: 20px; color: #ffffff; }
    input { border:1px solid #eaeaea; font-family: 'Roboto', sans-serif; outline:none; }
    input#number:hover { border-color: #a0a0a0 #b9b9b9 #b9b9b9 #b9b9b9; }
    input#number:focus { border-color: #28a745; }
    .rel { position: relative; }
    .center { margin: 5px auto; }
    .center button { min-width: 95px !important; vertical-align: baseline; height: 35px; margin-right: 5px; }
    .center button#call-button { margin: 0px !important; }
    .center button.hidden { display: none !important; }
    .content .center { width: 600px; }
    .content input,select { resize: none; padding: 5px; margin-right: 5px; }
    .total-cost { font-size: 40px !important; text-align: center; }
  </style>
</head>
<body>
<div class="container" id="home-container">
    <div class="content rel">
        <div class="center">
            <label for="haustyp" class="form-label">Haustyp</label>
            <select class="form-select" aria-label="Haustyp" id="haustyp">
                <option value="7512">Achat</option>
                <option value="9360">Bergkristall</option>
                <option value="7431">Ennert</option>
                <option value="8170">Ölberg</option>
                <option value="8638" selected>Petersberg</option>
                <option value="8974">Wolkenburg</option>
            </select>
        </div>
        <div class="center">
            <label for="ghgxn" class="form-label">Erzeugerpreise Gas (GHGXn)</label>
            <input type="range" class="form-range" min="50" max="1000" step="1.0" id="ghgxn">
        </div>
        <div class="center">
            <label for="xegin" class="form-label">European Gas Index (XEGIn)</label>
            <input type="range" class="form-range" min="50" max="500" step="1.0" id="xegin">
        </div>
        <div class="center">
            <label for="lexn" class="form-label">Index tariflicher Monatsgehälter (LEXn)</label>
            <input type="range" class="form-range" min="50" max="250" step="0.5" id="lexn">
        </div>
        <div class="center">
            <label for="mxn" class="form-label">Index Erzeugerpreise "gewerbliche Erzeugnisse" (MXn)</label>
            <input type="range" class="form-range" min="50" max="250" step="0.5" id="mxn">
        </div>
        <div class="center">
            <label for="kwh" class="form-label">Jahresverbrauch</label>
            <input type="range" class="form-range" min="5000" max="20000" step="100" id="kwh">
        </div>
        <div class="center">
            <div id="totalCost" class="total-cost"></div>
        </div>
        <div class="center">
            <div>
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th scope="col">GP04n</th>
                            <th scope="col">Grundpreis/Monat (brutto)</th>
                            <th scope="col">Grundpreis (brutto)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="summaryGP04n"></td>
                            <td id="summaryGP04nMonth"></td>
                            <td id="summaryGP04nTotal"></td>
                        </tr>
                    </tbody>
                    <thead>
                        <tr>
                            <th scope="col">AP01n</th>
                            <th scope="col">Verbrauch</th>
                            <th scope="col">Arbeitspreis (brutto)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="summaryAP01n"></td>
                            <td id="summaryKWh"></td>
                            <td id="summaryAP01nTotal"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="center">
            <div id="formulaAP01n"></div>
            <div id="formulaGP04n"></div>
        </div>
        <div class="center">
            <div id="stats"></div>
        </div>
    </div>
</div>
<!-- Javascript -->
<script type="text/javascript">
    const month = [ 'Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember' ];
    const gradTag = [ 17, 15, 13, 8, 4, (4/3), (4/3), (4/3), 3, 8, 12, 16 ];
    const ghgxnFix = [ 147.6, 147.2, 159.8, 164.0, 165.6 ];
    const xeginFix = [ 114.983, 85.545, 81.616, 133.486, 104.736, 95.448 ];
    const ghgx = 101.2;
    const co2 = 5.46;
    const LEX = 88.8;
    const MX = 100.3;
    const ghgxnStats = [
        { time: '2022-01', value: 0 },
        { time: '2022-02', value: 0 },
        { time: '2022-03', value: 0 },
        { time: '2022-04', value: 0 },
        { time: '2022-05', value: 0 },
        { time: '2022-06', value: 0 },
        { time: '2022-07', value: 0 },
        { time: '2022-08', value: 0 },
        { time: '2022-09', value: 0 },
        { time: '2022-10', value: 0 },
        { time: '2022-11', value: 0 },
        { time: '2022-12', value: 0 },
    ]
    const xeginStats = [
        { time: '2022-01', value: 0 },
        { time: '2022-02', value: 0 },
        { time: '2022-03', value: 0 },
        { time: '2022-04', value: 0 },
        { time: '2022-05', value: 0 },
        { time: '2022-06', value: 0 },
        { time: '2022-07', value: 0 },
        { time: '2022-08', value: 0 },
        { time: '2022-09', value: 0 },
        { time: '2022-10', value: 0 },
        { time: '2022-11', value: 0 },
        { time: '2022-12', value: 0 },
    ]
    const lexnStats = [
        { time: '2022-01', value: 0 },
        { time: '2022-02', value: 0 },
        { time: '2022-03', value: 0 },
        { time: '2022-04', value: 0 },
        { time: '2022-05', value: 0 },
        { time: '2022-06', value: 0 },
        { time: '2022-07', value: 0 },
        { time: '2022-08', value: 0 },
        { time: '2022-09', value: 0 },
        { time: '2022-10', value: 0 },
        { time: '2022-11', value: 0 },
        { time: '2022-12', value: 0 },
    ]
    const mxnStats = [
        { time: '2022-01', value: 0 },
        { time: '2022-02', value: 0 },
        { time: '2022-03', value: 0 },
        { time: '2022-04', value: 0 },
        { time: '2022-05', value: 0 },
        { time: '2022-06', value: 0 },
        { time: '2022-07', value: 0 },
        { time: '2022-08', value: 0 },
        { time: '2022-09', value: 0 },
        { time: '2022-10', value: 0 },
        { time: '2022-11', value: 0 },
        { time: '2022-12', value: 0 },
    ]

    var house = 86.38; // Petersberg
    var ghgxn = 200;
    $('#ghgxn').val(ghgxn);
    var xegin = 130;
    $('#xegin').val(xegin);
    var lexn = 101.5;
    $('#lexn').val(lexn);
    var mxn = 147.5;
    $('#mxn').val(mxn);
    var kwh = 7500;
    $('#kwh').val(kwh);
    $('#haustyp').change(() => {
        house = parseInt($('#haustyp').val()) / 100;
        calc();
    });
    $('#ghgxn').change(() => {
        ghgxn = $('#ghgxn').val();
        calc();
    });
    $('#xegin').change(() => {
        xegin = $('#xegin').val();
        calc();
    });
    $('#lexn').change(() => {
        lexn = $('#lexn').val();
        calc();
    });
    $('#mxn').change(() => {
        mxn = $('#mxn').val();
        calc();
    });
    $('#kwh').change(() => {
        kwh = $('#kwh').val();
        calc();
    });

    const chartOptions = {
        width: 600,
        height: 300,
        handleScroll: false,
        handleScale: false,
        grid: { 
            vertLines: {
                visible: false
            },
            horzLines: {
                visible: false
            }
        }
    };
    const chart = LightweightCharts.createChart(document.getElementById('stats'), chartOptions);
    const gasPreisChart = chart.addLineSeries({title: 'GHGXn', priceLineColor: '#ff0000', color: '#ff0000'});
    const egixChart = chart.addLineSeries({title: 'XEGIn', priceLineColor: '#0000ff', color: '#0000ff'});
    const lexnChart = chart.addLineSeries({title: 'LEXn', priceLineColor: '#00ff00', color: '#00ff00'});
    const mxnChart = chart.addLineSeries({title: 'MXn', priceLineColor: '#ff7f00', color: '#ff7f00'});

    function calc() {
        // calc GHGXn
        var newGHGXn = 0;
        for (let i = 0; i < month.length; i++) {
            const ghgxMonth = ghgxnFix[i] || ghgxn;
            ghgxnStats[i].value = ghgxMonth;
            const ghgxCalc = (gradTag[i] * ghgxMonth / 100);
            newGHGXn += ghgxCalc;
            console.log(`${month[i]} Gradtag:${gradTag[i]} Preis:${ghgxMonth} GHGXn:${ghgxCalc}/${newGHGXn}`);
        }
        const GHGXnGHGX = 0.5 * (newGHGXn / ghgx);
        console.log(`0.5 * ${newGHGXn} / ${ghgx} = ${round(GHGXnGHGX)}`);
        // calc XEGIn
        var newXEGIn = 0;
        for (let i = 0; i < month.length; i++) {
            const xegiMonth = xeginFix[i] || xegin;
            xeginStats[i].value = xegiMonth;
            const xegiCalc = gradTag[i] * ((xegiMonth / 100) + (co2 / 100))
            newXEGIn += xegiCalc;
            console.log(`${month[i]} Gradtag:${gradTag[i]} Preis:${xegiMonth} XEGIn:${xegiCalc}/${newXEGIn}`);
        }
        const XEGInXEGI = 0.5 * newXEGIn / 22.91;
        console.log(`0.5 * ${newXEGIn} / 22.91 = ${round(XEGInXEGI)}`);

        lexnStats.forEach(elem => elem.value = lexn)
        mxnStats.forEach(elem => elem.value = mxn)

        const nettoArbeitsPreis = 59 * (GHGXnGHGX + XEGInXEGI)
        const bruttoArbeitspreis = nettoArbeitsPreis * 1.19;
        const nettoGrundPreis = house * ( 0.8 + (0.08 * lexn / LEX) + (0.12 * mxn / MX));
        const bruttoGrundPreis = nettoGrundPreis * 1.19;
        const verbrauchsPreis = bruttoArbeitspreis * (kwh / 1000);
        console.log(`59 * (${GHGXnGHGX} + ${XEGInXEGI}) = ${nettoArbeitsPreis}`)
        $('#summaryAP01n').html(`${round(nettoArbeitsPreis)}€`);
        $('#summaryGP04n').html(`${round(nettoGrundPreis)}€`);
        $('#summaryKWh').html(`${kwh / 1000}MWh`);
        $('#summaryGP04nMonth').html(`${round(bruttoGrundPreis)}€`);
        $('#summaryGP04nTotal').html(`${round(bruttoGrundPreis * 12)}€`);
        $('#summaryAP01nTotal').html(`${round(verbrauchsPreis)}€`);
        
        gasPreisChart.setData(ghgxnStats);
        egixChart.setData(xeginStats);
        lexnChart.setData(lexnStats);
        mxnChart.setData(mxnStats);
        chart.timeScale().fitContent();

        $('#totalCost').html(`${round((bruttoGrundPreis * 12) + verbrauchsPreis)}€<br>Abschlag: ${round(bruttoGrundPreis + (verbrauchsPreis / 12))}€`);
        $('#formulaAP01n').text(`\\[AP01n = 0.5 * {${round(newGHGXn)} \\over ${ghgx}} + 0.5 * {${round(newXEGIn)} \\over 22.91}\\]`);
        $('#formulaGP04n').text(`\\[GP04n = ${house} * 0.8 + 0.08 * {${round(lexn)} \\over ${LEX}} + 0.12 * {${round(mxn)} \\over ${MX}}\\]`);
        MathJax.typeset();
        console.log(`ghgxn:${ghgxn} xegin:${xegin} bruttoArbeitspreis:${bruttoArbeitspreis} bruttoGrundPreis:${bruttoGrundPreis}`);
    }

    calc();

    function round(val) {
        return Math.round(val * 100) / 100;
    }
</script>
</body></html>
